name: Deploy Web (Next.js TS)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install & Build
        run: |
          npm ci
          npm run build

      - name: Archive build
        run: |
          tar -czf web_build.tgz \
            .next/standalone \
            .next/static \
            public \
            package.json

      - name: Upload to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "web_build.tgz"
          target: ${{ secrets.APP_DIR }}

      - name: Unpack & restart PM2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd ${{ secrets.APP_DIR }}
            rm -rf .next public package.json || true
            tar -xzf web_build.tgz && rm -f web_build.tgz
            if pm2 list | grep -q web-craftex; then
              pm2 restart web-craftex
            else
              PORT=4000 pm2 start ".next/standalone/server.js" --name web-craftex
            fi
            pm2 save
